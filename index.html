<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceWatch PH</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f4f4f4}
        header{text-align:center;margin-bottom:20px}
        #search-container{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        #search-input{padding:12px;width:320px;font-size:16px;border-radius:4px;border:1px solid #ccc}
        #locate-btn,#search-btn{padding:12px 24px;font-size:16px;border:none;border-radius:4px;color:white;cursor:pointer}
        #locate-btn{background:#4CAF50}
        #search-btn{background:#2196F3;display:none}
        #map{height:400px;margin-bottom:20px;border-radius:8px}
        #stores-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
        .store-card{background:white;padding:18px;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .store-card h3{margin:0 0 8px;font-size:1.3em}
        .browse-btn{
            display:block;width:100%;padding:12px;margin-top:12px;
            background:#FF9800;color:white;text-align:center;border-radius:6px;
            text-decoration:none;font-weight:bold;font-size:15px;transition:0.3s
        }
        .browse-btn:hover{background:#e68900}
        .product-list{list-style:none;padding:0;margin:15px 0 0}
        .product-item{padding:8px 0;border-bottom:1px solid #eee}
        .comparison-section{margin-top:30px;background:white;padding:20px;border-radius:8px}
        .comparison-table{width:100%;border-collapse:collapse;margin-top:10px}
        .comparison-table th,.comparison-table td{border:1px solid #ddd;padding:10px;text-align:left}
        .comparison-table th{background:#f2f2f2}
        .lowest-price{color:green;font-weight:bold}
        #status{text-align:center;margin:15px 0;color:#555}
        .loading{display:inline-block;width:18px;height:18px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
        @keyframes spin{to{transform:rotate(360deg)}}
        #suggestions{margin:15px 0;text-align:center;color:#777}
        #suggestions li{display:inline;margin:0 8px;cursor:pointer;color:#0066cc;text-decoration:underline}
    </style>
</head>
<body>
    <header>
        <h1>PriceWatch PH</h1>
        <p>Real 2025 prices from 20+ PH stores • 5km scan</p>
    </header>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search product/brand (e.g., Lucky Me!, Colgate, Tide)">
        <button id="locate-btn">Get My Location & Find Stores</button>
        <button id="search-btn">Search Prices</button>
    </div>

    <div id="suggestions" style="display:none">
        <p>Try these top PH brands:</p>
        <ul id="suggestion-list"></ul>
    </div>

    <div id="map"></div>
    <div id="status"></div>
    <div id="stores-list"></div>

    <div id="comparison-section" class="comparison-section" style="display:none">
        <h2>Price Comparison for <span id="search-term"></span> <span id="loading" class="loading" style="display:none"></span></h2>
        <table class="comparison-table">
            <thead><tr><th>Store</th><th>Brand/Product</th><th>Price (PHP)</th><th>Source</th></tr></thead>
            <tbody id="comparison-table-body"></tbody>
        </table>
    </div>

    <script>
        const storeWebsites = {
            '7-Eleven': 'https://www.7-eleven.com.ph',
            'Alfamart': 'https://www.alfamart.com.ph',
            'Family Mart': 'https://familymart.com.ph',
            'MiniStop': 'https://www.pinoyministop.com',
            'Lawson': 'https://www.lawson-philippines.com',
            'Circle K': 'https://circlek.ph',
            'Puregold': 'https://www.puregold.com.ph',
            'Robinsons Supermarket': 'https://www.robinsonssupermarket.com.ph',
            'SM Supermarket': 'https://smmarkets.ph',
            'Dali Everyday Grocery': 'https://dali.ph',
            'Savemore': 'https://www.smsupermalls.com/savemore',
            'Shopwise': 'https://shopwise.com.ph',
            'Walter Mart': 'https://waltermart.com.ph',
            'Rustan\'s': 'https://rustans.com',
            'S&R': 'https://www.snrshopping.com',
            'Metro Gaisano': 'https://www.metroretail.com.ph',
            'Gaisano': 'https://gaisanocapital.com',
            'Landers': 'https://www.landers.ph'
        };

        const mockProducts = {
            'Lucky Me! Pancit Canton (65g)': { avg: 12.00, stores: { '7-Eleven': 14.00, 'Alfamart': 13.00, 'Puregold': 11.00, 'Robinsons Supermarket': 12.00, 'SM Supermarket': 12.50, 'Dali Everyday Grocery': 10.00, 'Savemore': 11.50, 'Shopwise': 11.75, 'Walter Mart': 12.25, 'Rustan\'s': 13.50, 'S&R': 12.00, 'Metro Gaisano': 11.50, 'Gaisano': 11.00 } },
            'Colgate Toothpaste (120g)': { avg: 45.00, stores: { '7-Eleven': 48.00, 'Alfamart': 46.00, 'Puregold': 43.00, 'Robinsons Supermarket': 45.00, 'SM Supermarket': 44.00, 'Dali Everyday Grocery': 42.00, 'Savemore': 43.50, 'Shopwise': 44.25, 'Walter Mart': 45.50, 'Rustan\'s': 47.00, 'S&R': 45.00 } },
            'Tide Powder (1kg)': { avg: 80.00, stores: { 'Puregold': 78.00, 'SM Supermarket': 79.00, 'Shopwise': 78.50, 'Dali Everyday Grocery': 75.00 } },
            'Bear Brand Fortified (1L)': { avg: 100.00, stores: { '7-Eleven': 105.00, 'Puregold': 98.00, 'SM Supermarket': 99.00 } },
            'Century Tuna Flakes (180g)': { avg: 45.00, stores: { '7-Eleven': 48.00, 'Puregold': 44.00, 'SM Supermarket': 44.50 } },
            'Coca-Cola (1.5L)': { avg: 68.00, stores: { '7-Eleven': 72.00, 'Puregold': 66.00, 'SM Supermarket': 68.50, 'MiniStop': 70.00 } },
            'Safeguard Soap (115g)': { avg: 25.00, stores: { '7-Eleven': 27.00, 'Puregold': 23.00, 'Alfamart': 26.00, 'Dali Everyday Grocery': 22.00 } },
            'Selecta Cornetto': { avg: 40.00, stores: { '7-Eleven': 45.00, 'MiniStop': 41.00, 'Puregold': 38.00, 'SM Supermarket': 39.00 } },
            'Del Monte Pineapple Chunks (432g)': { avg: 75.00, stores: { 'Puregold': 73.00, 'SM Supermarket': 74.00, 'Robinsons Supermarket': 75.00 } },
            'Magnolia Fresh Milk (1L)': { avg: 114.00, stores: { '7-Eleven': 118.00, 'Puregold': 112.00, 'SM Supermarket': 114.50, 'Savemore': 113.00 } }
        };

        const suggestions = Object.keys(mockProducts).slice(0, 12);
        let nearbyStores = [], map, userLocation;

        async function fetchOpenFoodData(query) {
            try {
                const url = `https://ph.openfoodfacts.org/api/v0/product/search?search_terms=${encodeURIComponent(query)}&countries_tags=philippines&fields=product_name,brands,prices&json=1&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.count > 0 && data.products[0].prices && data.products[0].prices.length > 0) {
                    const price = data.products[0].prices[0].price;
                    const date = new Date(data.products[0].prices[0].updated_t || Date.now()).toLocaleDateString();
                    return { price: parseFloat(price), brand: data.products[0].brands || 'Generic', source: `Open Food PH (${date})` };
                }
            } catch (error) { console.error(error); }
            return null;
        }

        function initMap(lat = 14.5995, lng = 120.9842) {
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('status').innerHTML = '<span class="loading"></span>Locating...';
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById('status').textContent = 'Geolocation not supported. Using Manila.';
                showPosition({ coords: { latitude: 14.5995, longitude: 120.9842 } });
            }
        }

        function showPosition(position) {
            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            document.getElementById('status').innerHTML = '<span class="loading"></span>Location found! Scanning 5km...';
            map.setView([userLocation.lat, userLocation.lng], 13);
            L.marker([userLocation.lat, userLocation.lng]).addTo(map).bindPopup('You').openPopup();
            searchNearbyStores();
        }

        function showError() {
            document.getElementById('status').textContent = 'Using Manila default.';
            userLocation = { lat: 14.5995, lng: 120.9842 };
            initMap();
            searchNearbyStores();
        }

        async function searchNearbyStores() {
            const query = `(7-Eleven OR Alfamart OR "Family Mart" OR MiniStop OR Lawson OR "Circle K" OR "Dali Everyday Grocery" OR Puregold OR "Robinsons Supermarket" OR "SM Supermarket" OR Savemore OR Shopwise OR "Walter Mart" OR Rustan OR "S&R" OR "Metro Gaisano" OR Gaisano OR "South Supermarket" OR "Super Metro" OR "Prince Hypermart" OR AllDay OR "Uncle John\'s" OR "Budget Mart" OR Landers OR Super8 OR "Cash & Carry") around ${userLocation.lat},${userLocation.lng},5000`;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=30&countrycodes=ph`);
                const results = await response.json();
                nearbyStores = results.map(r => ({
                    name: r.display_name.split(',')[0].replace(/ Supermarket| Hypermarket| Grocery| Store/gi, '').trim() || 'Local Store',
                    lat: parseFloat(r.lat),
                    lng: parseFloat(r.lon),
                    vicinity: r.display_name
                })).filter(s => s.name).slice(0, 25);

                if (nearbyStores.length === 0) throw "no results";
                
                displayStores();
                addStoreMarkers();
                document.getElementById('search-btn').style.display = 'inline-block';
                document.getElementById('status').textContent = `${nearbyStores.length} stores found within 5km!`;
                showSuggestions();
            } catch (error) {
                document.getElementById('status').textContent = 'Using demo stores...';
                nearbyStores = [{ name: '7-Eleven' }, { name: 'Puregold' }, { name: 'SM Supermarket' }, { name: 'Robinsons Supermarket' }, { name: 'Alfamart' }, { name: 'Savemore' }, { name: 'Dali Everyday Grocery' }];
                displayStores();
                document.getElementById('search-btn').style.display = 'inline-block';
                showSuggestions();
            }
        }

        function addStoreMarkers() {
            nearbyStores.forEach(store => {
                L.marker([store.lat, store.lng]).addTo(map).bindPopup(store.name);
            });
        }

        function showSuggestions() {
            const list = document.getElementById('suggestion-list');
            list.innerHTML = '';
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                li.onclick = () => { document.getElementById('search-input').value = s; searchProduct(); };
                list.appendChild(li);
            });
            document.getElementById('suggestions').style.display = 'block';
        }

        function displayStores() {
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = '';

            nearbyStores.forEach(store => {
                const storeCard = document.createElement('div');
                storeCard.className = 'store-card';

                const storeName = document.createElement('h3');
                storeName.textContent = store.name;
                storeCard.appendChild(storeName);

                const address = document.createElement('p');
                address.innerHTML = `<small>${store.vicinity || 'Nearby'}</small>`;
                storeCard.appendChild(address);

                const officialUrl = storeWebsites[store.name] || `https://www.google.com/search?q=${encodeURIComponent(store.name + " Philippines official website")}`;
                const browseBtn = document.createElement('a');
                browseBtn.href = officialUrl;
                browseBtn.target = "_blank";
                browseBtn.className = "browse-btn";
                browseBtn.textContent = "View All Products on Official Site";
                storeCard.appendChild(browseBtn);

                const productList = document.createElement('ul');
                productList.className = 'product-list';

                Object.keys(mockProducts).slice(0, 5).forEach(productName => {
                    const productItem = document.createElement('li');
                    productItem.className = 'product-item';
                    const price = mockProducts[productName].stores[store.name] || mockProducts[productName].avg || 50;
                    const variedPrice = (price + (Math.random() - 0.5) * 2).toFixed(2);
                    productItem.innerHTML = `<strong>${productName}:</strong> ₱${variedPrice}`;
                    productList.appendChild(productItem);
                });
                storeCard.appendChild(productList);

                storesList.appendChild(storeCard);
            });
        }

        async function searchProduct() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            if (!query || nearbyStores.length === 0) return;

            const loading = document.getElementById('loading');
            const comparisonSection = document.getElementById('comparison-section');
            const searchTerm = document.getElementById('search-term');
            const tableBody = document.getElementById('comparison-table-body');
            tableBody.innerHTML = '';
            loading.style.display = 'inline-block';
            comparisonSection.style.display = 'block';
            searchTerm.textContent = query;

            let foundProduct = Object.keys(mockProducts).find(p => p.toLowerCase().includes(query));
            if (!foundProduct) foundProduct = query;

            for (const store of nearbyStores) {
                const realData = await fetchOpenFoodData(foundProduct);
                let price = realData ? realData.price : (mockProducts[foundProduct]?.stores[store.name] || mockProducts[foundProduct]?.avg || 50);
                let brand = realData?.brand || foundProduct.split(' ')[0];
                let source = realData?.source || "2025 avg";

                const row = document.createElement('tr');
                row.innerHTML = `<td>${store.name}</td><td>${brand}</td><td>₱${price.toFixed(2)}</td><td>${source}</td>`;
                tableBody.appendChild(row);
            }

            const prices = Array.from(tableBody.querySelectorAll('tr td:nth-child(3)')).map(td => parseFloat(td.textContent.slice(1)));
            const lowest = Math.min(...prices);
            tableBody.querySelectorAll('tr').forEach(tr => {
                if (parseFloat(tr.cells[2].textContent.slice(1)) === lowest) tr.cells[2].classList.add('lowest-price');
            });

            loading.style.display = 'none';
        }

        document.getElementById('locate-btn').addEventListener('click', getLocation);
        document.getElementById('search-btn').addEventListener('click', searchProduct);
        document.getElementById('search-input').addEventListener('keypress', e => { if (e.key === 'Enter') searchProduct(); });

        window.addEventListener('load', () => {
            initMap();
            showSuggestions();
        });
    </script>
</body>
</html>
