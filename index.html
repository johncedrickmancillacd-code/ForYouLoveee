<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceWatch PH</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        #search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #search-input {
            padding: 10px;
            width: 300px;
            font-size: 16px;
        }
        #locate-btn, #search-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }
        #search-btn {
            background-color: #2196F3;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        #stores-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .store-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .store-card h3 {
            margin-top: 0;
        }
        .product-list {
            list-style: none;
            padding: 0;
        }
        .product-item {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .comparison-section {
            margin-top: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
        }
        .lowest-price {
            color: green;
            font-weight: bold;
        }
        .real-price {
            color: blue;
            font-style: italic;
        }
        #status {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #suggestions {
            text-align: center;
            margin-top: 10px;
            color: #888;
        }
        #suggestions ul {
            list-style: none;
            padding: 0;
        }
        #suggestions li {
            display: inline;
            margin: 0 5px;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <h1>PriceWatch PH</h1>
        <p>Free price comparison for nearby stores in the Philippines</p>
    </header>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search for a product (e.g., Rice)">
        <button id="locate-btn">Get My Location & Find Stores</button>
        <button id="search-btn" style="display: none;">Search Prices</button>
    </div>
    <div id="suggestions" style="display: none;">
        <p>Try these common PH items:</p>
        <ul id="suggestion-list"></ul>
    </div>

    <div id="map"></div>

    <div id="status"></div>

    <div id="stores-list"></div>

    <div id="comparison-section" class="comparison-section" style="display: none;">
        <h2>Price Comparison for <span id="search-term"></span> <span id="loading" class="loading" style="display: none;"></span></h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Store</th>
                    <th>Price (PHP)</th>
                    <th>Source</th>
                </tr>
            </thead>
            <tbody id="comparison-table-body"></tbody>
        </table>
        <p style="font-size: 12px; color: #888;">Real prices from <a href="https://ph.openfoodfacts.org" target="_blank">Open Food Facts PH</a> (crowdsourced). Fallbacks are PH market averages.</p>
    </div>

    <script>
        // Open Prices API base URL (free, no key; PH-focused endpoint)
        const OPEN_PRICES_API = 'https://world.openfoodfacts.org/api/v0';

        // PH-specific mock data as fallback (prices in PHP, based on avg 2025 market rates)
        const mockProducts = {
            'Rice': { avg: 55.00, stores: { '7-Eleven': 58.00, 'Puregold': 52.00, 'Robinsons': 55.00, 'SM Supermarket': 54.00 } },
            'Canned Sardines': { avg: 25.00, stores: { '7-Eleven': 28.00, 'Puregold': 23.00, 'Robinsons': 25.00, 'SM Supermarket': 24.00 } },
            'Eggs (6pcs)': { avg: 45.00, stores: { '7-Eleven': 48.00, 'Puregold': 42.00, 'Robinsons': 45.00, 'SM Supermarket': 44.00 } },
            'Cooking Oil (1L)': { avg: 80.00, stores: { '7-Eleven': 85.00, 'Puregold': 78.00, 'Robinsons': 80.00, 'SM Supermarket': 79.00 } },
            'Adobo Mix': { avg: 15.00, stores: { '7-Eleven': 16.00, 'Puregold': 14.00, 'Robinsons': 15.00, 'SM Supermarket': 15.00 } },
            'Bottled Water (500ml)': { avg: 12.00, stores: { '7-Eleven': 15.00, 'Puregold': 10.00, 'Robinsons': 12.00, 'SM Supermarket': 11.00 } },
            'Bread (loaf)': { avg: 35.00, stores: { '7-Eleven': 38.00, 'Puregold': 32.00, 'Robinsons': 35.00, 'SM Supermarket': 34.00 } }
        };

        // Suggestion list
        const suggestions = Object.keys(mockProducts);

        let nearbyStores = [];
        let map;
        let userLocation;

        // Initialize free Leaflet map with OSM
        function initMap(lat = 14.5995, lng = 120.9842) { // Default to Manila
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Get user location
        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('status').innerHTML = '<span class="loading"></span>Locating...';
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById('status').textContent = 'Geolocation not supported. Using Manila as default.';
                showPosition({ coords: { latitude: 14.5995, longitude: 120.9842 } });
            }
        }

        // Handle location success
        function showPosition(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            document.getElementById('status').innerHTML = '<span class="loading"></span>Location found! Searching nearby stores...';

            map.setView([userLocation.lat, userLocation.lng], 14);
            L.marker([userLocation.lat, userLocation.lng]).addTo(map).bindPopup('Your Location');

            searchNearbyStores();
        }

        // Handle location error
        function showError(error) {
            document.getElementById('status').textContent = 'Using default Manila location.';
            userLocation = { lat: 14.5995, lng: 120.9842 };
            initMap();
            searchNearbyStores();
        }

        // Search nearby stores with free Nominatim API
        async function searchNearbyStores() {
            try {
                const query = `convenience_store OR grocery OR supermarket around ${userLocation.lat},${userLocation.lng},1000`; // 1km radius
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1`);
                const results = await response.json();
                nearbyStores = results.map(r => ({ name: r.display_name.split(',')[0], lat: parseFloat(r.lat), lng: parseFloat(r.lon), vicinity: r.display_name })).slice(0, 10);
                
                if (nearbyStores.length === 0) {
                    // Fallback to PH demo stores
                    nearbyStores = [
                        { name: '7-Eleven', lat: userLocation.lat + 0.001, lng: userLocation.lng + 0.001, vicinity: 'Nearby Manila' },
                        { name: 'Puregold', lat: userLocation.lat - 0.001, lng: userLocation.lng - 0.001, vicinity: 'Nearby Manila' },
                        { name: 'Robinsons', lat: userLocation.lat + 0.002, lng: userLocation.lng, vicinity: 'Nearby Manila' },
                        { name: 'SM Supermarket', lat: userLocation.lat, lng: userLocation.lng + 0.002, vicinity: 'Nearby Manila' }
                    ];
                }

                displayStores();
                addStoreMarkers();
                document.getElementById('search-btn').style.display = 'inline-block';
                document.getElementById('status').textContent = `${nearbyStores.length} nearby stores found! Search a product to compare.`;
                showSuggestions();
            } catch (error) {
                document.getElementById('status').textContent = 'Search error—using demo stores.';
                nearbyStores = [{ name: '7-Eleven' }, { name: 'Puregold' }, { name: 'Robinsons' }, { name: 'SM Supermarket' }];
                displayStores();
                document.getElementById('search-btn').style.display = 'inline-block';
                showSuggestions();
            }
        }

        // Add markers to map
        function addStoreMarkers() {
            nearbyStores.forEach(store => {
                L.marker([store.lat, store.lng]).addTo(map).bindPopup(store.name);
            });
        }

        // Show product suggestions
        function showSuggestions() {
            const suggDiv = document.getElementById('suggestions');
            const list = document.getElementById('suggestion-list');
            list.innerHTML = '';
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                li.onclick = () => document.getElementById('search-input').value = s;
                list.appendChild(li);
            });
            suggDiv.style.display = 'block';
        }

        // Display stores with mock products
        function displayStores() {
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = '';

            nearbyStores.forEach(store => {
                const storeCard = document.createElement('div');
                storeCard.className = 'store-card';

                const storeName = document.createElement('h3');
                storeName.textContent = store.name;
                storeCard.appendChild(storeName);

                const address = document.createElement('p');
                address.textContent = `Address: ${store.vicinity || 'Nearby'}`;
                storeCard.appendChild(address);

                const productList = document.createElement('ul');
                productList.className = 'product-list';

                Object.keys(mockProducts).forEach(productName => {
                    const productItem = document.createElement('li');
                    productItem.className = 'product-item';
                    const variedPrice = (mockProducts[productName].stores[store.name] || mockProducts[productName].avg + (Math.random() - 0.5) * 2).toFixed(2);
                    productItem.innerHTML = `<strong>${productName}:</strong> ₱${variedPrice} (mock)`;
                    productList.appendChild(productItem);
                });

                storeCard.appendChild(productList);
                storesList.appendChild(storeCard);
            });
        }

        // Fetch real prices from Open Food Facts
        async function fetchRealPrices(productName, storeName) {
            try {
                const response = await fetch(`${OPEN_PRICES_API}/product/search?search_terms=${encodeURIComponent(productName)}&stores_tags_en=${encodeURIComponent(storeName)}&fields=products.prices&json=1&limit=1`);
                const data = await response.json();
                if (data.count > 0 && data.products[0].prices && data.products[0].prices.length > 0) {
                    const price = data.products[0].prices[0].price;
                    const date = new Date(data.products[0].prices[0].updated_t).toLocaleDateString();
                    return { price: parseFloat(price), source: `Real (as of ${date})` };
                }
            } catch (error) {
                console.error('API fetch error:', error);
            }
            return null;
        }

        // Search product and compare
        async function searchProduct() {
            const query = document.getElementById('search-input').value.trim();
            if (!query || nearbyStores.length === 0) return;

            const loading = document.getElementById('loading');
            const comparisonSection = document.getElementById('comparison-section');
            const searchTerm = document.getElementById('search-term');
            const tableBody = document.getElementById('comparison-table-body');
            tableBody.innerHTML = '';
            loading.style.display = 'inline-block';
            comparisonSection.style.display = 'block';

            searchTerm.textContent = query;
            let prices = [];

            for (const store of nearbyStores) {
                const realPriceData = await fetchRealPrices(query, store.name);
                let price, source;
                if (realPriceData) {
                    price = realPriceData.price;
                    source = realPriceData.source;
                } else {
                    const mockData = mockProducts[query] || { avg: 50.00 };
                    price = mockData.stores[store.name] || mockData.avg;
                    source = 'PH avg (mock)';
                }
                prices.push({ store: store.name, price, source });

                const row = document.createElement('tr');
                const storeCell = document.createElement('td');
                storeCell.textContent = store.name;
                const priceCell = document.createElement('td');
                priceCell.innerHTML = `₱${price.toFixed(2)}`;
                if (realPriceData) priceCell.classList.add('real-price');
                const sourceCell = document.createElement('td');
                sourceCell.textContent = source;
                row.appendChild(storeCell);
                row.appendChild(priceCell);
                row.appendChild(sourceCell);
                tableBody.appendChild(row);
            }

            loading.style.display = 'none';

            // Highlight lowest
            const lowestPrice = Math.min(...prices.map(p => p.price));
            tableBody.querySelectorAll('tr').forEach(row => {
                const priceCell = row.cells[1];
                if (parseFloat(priceCell.textContent.replace('₱', '')) === lowestPrice) {
                    priceCell.classList.add('lowest-price');
                }
            });
        }

        // Event listeners
        document.getElementById('locate-btn').addEventListener('click', getLocation);
        document.getElementById('search-btn').addEventListener('click', searchProduct);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProduct();
        });

        // Load map on start
        window.addEventListener('load', () => {
            initMap();
            showSuggestions();
        });
    </script>
</body>
</html>
