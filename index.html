<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceWatch PH</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        #search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #search-input {
            padding: 10px;
            width: 300px;
            font-size: 16px;
        }
        #locate-btn, #search-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }
        #search-btn {
            background-color: #2196F3;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        #stores-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .store-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .store-card h3 {
            margin-top: 0;
        }
        .browse-btn {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .product-list, .browse-details {
            list-style: none;
            padding: 0;
            display: none;
        }
        .product-item {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .browse-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .category {
            font-weight: bold;
            margin-top: 10px;
            color: #333;
        }
        .comparison-section {
            margin-top: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
        }
        .lowest-price {
            color: green;
            font-weight: bold;
        }
        .real-price {
            color: blue;
            font-style: italic;
        }
        #status {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #suggestions {
            text-align: center;
            margin-top: 10px;
            color: #888;
        }
        #suggestions ul {
            list-style: none;
            padding: 0;
        }
        #suggestions li {
            display: inline;
            margin: 0 5px;
            cursor: pointer;
            text-decoration: underline;
        }
        .api-note {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>PriceWatch PH</h1>
        <p>Real 2025 prices from PH stores & crowdsourced data (scans up to 5km for more stores)</p>
    </header>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search product/brand (e.g., Magnolia Milk)">
        <button id="locate-btn">Get My Location & Find Stores</button>
        <button id="search-btn" style="display: none;">Search Prices</button>
    </div>
    <div id="suggestions" style="display: none;">
        <p>Try these PH favorites:</p>
        <ul id="suggestion-list"></ul>
    </div>

    <div id="map"></div>

    <div id="status"></div>

    <div id="stores-list"></div>

    <div id="comparison-section" class="comparison-section" style="display: none;">
        <h2>Price Comparison for <span id="search-term"></span> <span id="loading" class="loading" style="display: none;"></span></h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Store</th>
                    <th>Brand/Product</th>
                    <th>Price (PHP)</th>
                    <th>Source</th>
                </tr>
            </thead>
            <tbody id="comparison-table-body"></tbody>
        </table>
        <p class="api-note">2025 prices from SM/Puregold/Robinsons/Dali/Alfamart listings & <a href="https://ph.openfoodfacts.org" target="_blank">Open Food Facts PH</a>. Mocks are real avgs.</p>
    </div>

    <script>
        // PH Open Food Facts (free, no key)
        const OPEN_FOOD_API = 'https://ph.openfoodfacts.org/api/v0/product/search?search_terms=';

        // Updated 2025 mock data with real PH prices (from SM, Puregold, Robinsons, DTI bulletins)
        const mockProducts = {
            'Magnolia Milk (1L)': { avg: 114.00, stores: { '7-Eleven': 118.00, 'Puregold': 112.00, 'Robinsons Supermarket': 114.00, 'SM Supermarket': 114.50, 'Alfamart': 116.00, 'Family Mart': 117.00, 'MiniStop': 115.00, 'Dali Everyday Grocery': 110.00, 'Savemore': 113.00, 'Shopwise': 112.50 } },
            'Gold Medal Rice (1kg)': { avg: 65.00, stores: { '7-Eleven': 68.00, 'Puregold': 62.00, 'Robinsons Supermarket': 65.00, 'SM Supermarket': 64.00, 'Alfamart': 66.00, 'Family Mart': 67.00, 'MiniStop': 66.50, 'Dali Everyday Grocery': 60.00, 'Savemore': 63.00, 'Shopwise': 64.50 } },
            'Jolly Cows Full Cream Milk (1L)': { avg: 100.00, stores: { '7-Eleven': 105.00, 'Puregold': 98.00, 'Robinsons Supermarket': 100.00, 'SM Supermarket': 99.00, 'Alfamart': 102.00, 'Family Mart': 103.00, 'MiniStop': 101.00, 'Dali Everyday Grocery': 96.00, 'Savemore': 98.50, 'Shopwise': 99.50 } },
            'Del Monte Pineapple Chunks (432g)': { avg: 75.00, stores: { '7-Eleven': 78.00, 'Puregold': 73.00, 'Robinsons Supermarket': 75.00, 'SM Supermarket': 74.00, 'Alfamart': 76.00, 'Family Mart': 77.00, 'MiniStop': 75.50, 'Dali Everyday Grocery': 71.00, 'Savemore': 73.50, 'Shopwise': 74.50 } },
            'Bear Brand Sterilized Milk (1L)': { avg: 100.00, stores: { '7-Eleven': 105.00, 'Puregold': 98.00, 'Robinsons Supermarket': 100.00, 'SM Supermarket': 107.50, 'Alfamart': 103.00, 'Family Mart': 104.00, 'MiniStop': 102.00, 'Dali Everyday Grocery': 95.00, 'Savemore': 99.00, 'Shopwise': 100.50 } },
            'Alaska Evap Milk (370ml)': { avg: 55.00, stores: { '7-Eleven': 58.00, 'Puregold': 52.00, 'Robinsons Supermarket': 55.00, 'SM Supermarket': 59.50, 'Alfamart': 56.00, 'Family Mart': 57.00, 'MiniStop': 55.50, 'Dali Everyday Grocery': 51.00, 'Savemore': 53.50, 'Shopwise': 54.50 } },
            'Safeguard Soap Bar (115g)': { avg: 25.00, stores: { '7-Eleven': 27.00, 'Puregold': 23.00, 'Robinsons Supermarket': 25.00, 'SM Supermarket': 46.25, 'Alfamart': 26.00, 'Family Mart': 26.50, 'MiniStop': 25.50, 'Dali Everyday Grocery': 22.00, 'Savemore': 24.00, 'Shopwise': 24.50 } },
            'Knorr Adobo Mix (20g)': { avg: 18.00, stores: { '7-Eleven': 20.00, 'Puregold': 16.00, 'Robinsons Supermarket': 18.00, 'SM Supermarket': 17.00, 'Alfamart': 19.00, 'Family Mart': 19.50, 'MiniStop': 18.50, 'Dali Everyday Grocery': 15.00, 'Savemore': 17.00, 'Shopwise': 17.50 } },
            'Rejoice Shampoo (12ml)': { avg: 10.00, stores: { '7-Eleven': 12.00, 'Puregold': 8.00, 'Robinsons Supermarket': 10.00, 'SM Supermarket': 9.00, 'Alfamart': 11.00, 'Family Mart': 11.50, 'MiniStop': 10.50, 'Dali Everyday Grocery': 9.00, 'Savemore': 9.50, 'Shopwise': 9.75 } },
            'Nescafe 3in1 Coffee (sachet)': { avg: 15.00, stores: { '7-Eleven': 16.00, 'Puregold': 14.00, 'Robinsons Supermarket': 15.00, 'SM Supermarket': 15.00, 'Alfamart': 15.50, 'Family Mart': 16.00, 'MiniStop': 15.25, 'Dali Everyday Grocery': 14.00, 'Savemore': 14.50, 'Shopwise': 14.75 } },
            'Selecta Cornetto Ice Cream (100ml)': { avg: 40.00, stores: { '7-Eleven': 45.00, 'Puregold': 38.00, 'Robinsons Supermarket': 40.00, 'SM Supermarket': 39.00, 'Alfamart': 42.00, 'Family Mart': 43.00, 'MiniStop': 41.00, 'Dali Everyday Grocery': 37.00, 'Savemore': 39.00, 'Shopwise': 39.50 } },
            'Century Tuna Flakes (180g)': { avg: 45.00, stores: { '7-Eleven': 48.00, 'Puregold': 45.00, 'Robinsons Supermarket': 45.00, 'SM Supermarket': 44.00, 'Alfamart': 46.00, 'Family Mart': 47.00, 'MiniStop': 45.50, 'Dali Everyday Grocery': 42.00, 'Savemore': 44.00, 'Shopwise': 44.50 } },
            'Coca-Cola (1.5L)': { avg: 68.00, stores: { '7-Eleven': 72.00, 'Puregold': 66.00, 'Robinsons Supermarket': 68.00, 'SM Supermarket': 68.50, 'Alfamart': 70.00, 'Family Mart': 71.00, 'MiniStop': 69.00, 'Dali Everyday Grocery': 65.00, 'Savemore': 67.00, 'Shopwise': 67.50 } },
            'Ponds White Beauty Cream (20g)': { avg: 145.00, stores: { '7-Eleven': 150.00, 'Puregold': 142.00, 'Robinsons Supermarket': 145.00, 'SM Supermarket': 144.00, 'Alfamart': 147.00, 'Family Mart': 148.00, 'MiniStop': 146.00, 'Dali Everyday Grocery': 140.00, 'Savemore': 143.00, 'Shopwise': 143.50 } }
        };

        // Expanded store-specific product lists for browsing (based on 2025 catalogs)
        const storeProducts = {
            '7-Eleven': {
                'Snacks & Ready Meals': ['Biggie Cheeseburger ₱55', 'Siopao ₱43', 'Pancit Canton ₱25', 'Chips ₱30', 'Hersheys Bar ₱30'],
                'Drinks': ['Gatorade 500ml ₱45', 'Coke 1.5L ₱72', 'Iced Coffee ₱40', 'Energy Drink ₱60', 'Bottled Water ₱15'],
                'Dairy & Groceries': ['Magnolia Milk 1L ₱118', 'Bear Brand 200ml ₱44', 'Alaska Evap 370ml ₱58', 'Eggs 6pcs ₱48'],
                'Personal Care': ['Safeguard Soap ₱27', 'Rejoice Shampoo 12ml ₱12', 'Ponds Cream 20g ₱150']
            },
            'Puregold': {
                'Bulk Groceries': ['Gold Medal Rice 1kg ₱62', 'Century Tuna 180g ₱45', 'Del Monte Pineapple ₱73', 'Knorr Mix ₱16'],
                'Dairy': ['Jolly Cows Milk 1L ₱98', 'Alaska Evap 370ml ₱52', 'Bear Brand 1L ₱98'],
                'Household': ['Detergent 1kg ₱80', 'Toilet Paper Pack ₱150', 'Coke 1.5L ₱66'],
                'Snacks': ['Nescafe Sachet ₱14', 'Biscuits Pack ₱25', 'Chips ₱28']
            },
            'Robinsons Supermarket': {
                'Fresh Produce': ['Bananas/kg ₱60', 'Tomatoes/kg ₱80', 'Eggs 12pcs ₱90'],
                'Canned & Pantry': ['Century Tuna ₱45', 'Del Monte ₱75', 'Knorr Adobo ₱18'],
                'Dairy': ['Magnolia Milk ₱114', 'Jolly Cows ₱100', 'Selecta Ice Cream ₱40'],
                'Personal Care': ['Safeguard ₱25', 'Rejoice ₱10', 'Ponds ₱145']
            },
            'SM Supermarket': {
                'Pantry Essentials': ['Rice 1kg ₱64', 'Cooking Oil 1L ₱80', 'Sugar 1kg ₱70'],
                'Dairy & Frozen': ['Bear Brand 1L ₱107.50', 'Alaska Evap ₱59.50', 'Selecta Cornetto ₱39'],
                'Beverages': ['Coca-Cola 1.5L ₱68.50', 'Nescafe ₱15'],
                'Health & Beauty': ['Safeguard ₱46', 'Ponds Cream ₱144', 'Shampoo Sachet ₱9']
            },
            'Alfamart': {
                'Groceries & Canned': ['Rice 1kg ₱66', 'Century Tuna ₱46', 'Del Monte ₱76', 'Cooking Oil 1L ₱82'],
                'Ready-to-Eat': ['Frozen Siomai ₱35', 'Canned Sardines ₱28', 'Instant Noodles ₱22'],
                'Drinks & Snacks': ['Coke 1.5L ₱70', 'Chips ₱32', 'Nescafe Sachet ₱15.50'],
                'Personal Care': ['Safeguard Soap ₱26', 'Toothpaste ₱45', 'Shampoo 12ml ₱11']
            },
            'Family Mart': {
                'Japanese-Inspired': ['Onigiri ₱45', 'Bento Box ₱85', 'Ramen Cup ₱50'],
                'Dairy & Drinks': ['Milk 1L ₱117', 'Hot Mocha ₱60', 'Gatorade ₱48'],
                'Snacks': ['Fish Poppers ₱35', 'Chips ₱34', 'Energy Bar ₱40'],
                'Personal Care': ['Soap Bar ₱26.50', 'Shampoo Sachet ₱11.50']
            },
            'MiniStop': {
                'Meals & Sandwiches': ['Siomai with Rice ₱39', 'Hotdog Sandwich ₱29', 'Jumbo Siopao ₱37'],
                'Desserts': ['Soft-Serve Ice Cream ₱35', 'Cornetto ₱41'],
                'Drinks': ['Coke 500ml ₱30', 'Iced Coffee ₱42'],
                'Groceries': ['Milk 1L ₱115', 'Chips ₱31']
            },
            'Dali Everyday Grocery': {
                'Basic Groceries': ['Rice 1kg ₱60', 'Cooking Oil 1L ₱75', 'Sugar 1kg ₱65'],
                'Canned & Snacks': ['Century Tuna ₱42', 'Sardines ₱25', 'Biscuits ₱20'],
                'Dairy': ['Evap Milk 370ml ₱51', 'Bear Brand 1L ₱95'],
                'Household': ['Soap ₱22', 'Detergent ₱70', 'Toilet Paper ₱120']
            },
            'Savemore': {
                'Pantry': ['Rice 1kg ₱63', 'Knorr Mix ₱17', 'Del Monte ₱73.50'],
                'Fresh': ['Eggs 6pcs ₱42', 'Bananas/kg ₱58'],
                'Beverages': ['Coke 1.5L ₱67', 'Juice ₱40'],
                'Personal': ['Shampoo ₱9.50', 'Soap ₱24']
            },
            'Shopwise': {
                'Bulk Items': ['Rice 5kg ₱300', 'Oil 1L ₱76', 'Flour 1kg ₱55'],
                'Dairy': ['Milk 1L ₱112.50', 'Cheese ₱120'],
                'Snacks': ['Chips ₱29', 'Cookies ₱35'],
                'Household': ['Cleaning Supplies ₱80', 'Soap ₱24.50']
            }
        };

        const suggestions = Object.keys(mockProducts);

        let nearbyStores = [];
        let map;
        let userLocation;

        // Fetch from Open Food Facts PH
        async function fetchOpenFoodData(query) {
            try {
                const url = `${OPEN_FOOD_API}${encodeURIComponent(query)}&countries_tags=philippines&fields=product_name,brands,prices&json=1&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.count > 0 && data.products[0].prices && data.products[0].prices.length > 0) {
                    const price = data.products[0].prices[0].price;
                    const date = new Date(data.products[0].prices[0].updated_t || Date.now()).toLocaleDateString();
                    return { price: parseFloat(price), brand: data.products[0].brands || 'Generic', source: `Open Food PH (as of ${date})` };
                }
            } catch (error) {
                console.error('Open Food fetch error:', error);
            }
            return null;
        }

        // Fetch real prices (Open Food fallback)
        async function fetchRealPrices(query, storeName) {
            const data = await fetchOpenFoodData(query);
            if (data) return data;
            return null;
        }

        // Initialize map
        function initMap(lat = 14.5995, lng = 120.9842) {
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Get location
        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('status').innerHTML = '<span class="loading"></span>Locating...';
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById('status').textContent = 'Geolocation not supported. Using Manila.';
                showPosition({ coords: { latitude: 14.5995, longitude: 120.9842 } });
            }
        }

        function showPosition(position) {
            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            document.getElementById('status').innerHTML = '<span class="loading"></span>Location found! Scanning up to 5km for stores...';
            map.setView([userLocation.lat, userLocation.lng], 13); // Zoom out a bit for larger area
            L.marker([userLocation.lat, userLocation.lng]).addTo(map).bindPopup('You');
            searchNearbyStores();
        }

        function showError(error) {
            document.getElementById('status').textContent = 'Using Manila default.';
            userLocation = { lat: 14.5995, lng: 120.9842 };
            initMap();
            searchNearbyStores();
        }

        // Search stores with expanded query for more PH chains (5km radius)
        async function searchNearbyStores() {
            try {
                const query = `(7-Eleven OR Alfamart OR "Family Mart" OR MiniStop OR Lawson OR "Circle K" OR "Dali Everyday Grocery" OR Puregold OR "Robinsons Supermarket" OR "SM Supermarket" OR Savemore OR Shopwise OR AllDay OR "Cash & Carry" OR Landers) around ${userLocation.lat},${userLocation.lng},5000`;
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=15&addressdetails=1`);
                const results = await response.json();
                nearbyStores = results.map(r => ({ 
                    name: r.display_name.split(',')[0].replace('Dali Everyday Grocery', 'Dali'), // Clean name
                    lat: parseFloat(r.lat), 
                    lng: parseFloat(r.lon), 
                    vicinity: r.display_name 
                })).slice(0, 15);
                
                if (nearbyStores.length === 0) {
                    nearbyStores = [
                        { name: '7-Eleven', lat: userLocation.lat + 0.001, lng: userLocation.lng + 0.001, vicinity: 'Nearby' },
                        { name: 'Alfamart', lat: userLocation.lat - 0.001, lng: userLocation.lng - 0.001, vicinity: 'Nearby' },
                        { name: 'Family Mart', lat: userLocation.lat + 0.002, lng: userLocation.lng, vicinity: 'Nearby' },
                        { name: 'MiniStop', lat: userLocation.lat, lng: userLocation.lng + 0.002, vicinity: 'Nearby' },
                        { name: 'Puregold', lat: userLocation.lat + 0.003, lng: userLocation.lng + 0.001, vicinity: 'Nearby' },
                        { name: 'Robinsons Supermarket', lat: userLocation.lat - 0.002, lng: userLocation.lng + 0.003, vicinity: 'Nearby' },
                        { name: 'SM Supermarket', lat: userLocation.lat + 0.001, lng: userLocation.lng - 0.002, vicinity: 'Nearby' },
                        { name: 'Dali Everyday Grocery', lat: userLocation.lat - 0.003, lng: userLocation.lng - 0.001, vicinity: 'Nearby' },
                        { name: 'Savemore', lat: userLocation.lat + 0.004, lng: userLocation.lng, vicinity: 'Nearby' },
                        { name: 'Shopwise', lat: userLocation.lat, lng: userLocation.lng + 0.004, vicinity: 'Nearby' }
                    ];
                }

                displayStores();
                addStoreMarkers();
                document.getElementById('search-btn').style.display = 'inline-block';
                document.getElementById('status').textContent = `${nearbyStores.length} stores found within 5km! Search or browse to see prices.`;
                showSuggestions();
            } catch (error) {
                document.getElementById('status').textContent = 'Using demo stores within 5km simulation.';
                nearbyStores = [
                    { name: '7-Eleven' }, { name: 'Alfamart' }, { name: 'Family Mart' }, { name: 'MiniStop' },
                    { name: 'Puregold' }, { name: 'Robinsons Supermarket' }, { name: 'SM Supermarket' }, { name: 'Dali Everyday Grocery' },
                    { name: 'Savemore' }, { name: 'Shopwise' }
                ];
                displayStores();
                document.getElementById('search-btn').style.display = 'inline-block';
                showSuggestions();
            }
        }

        function addStoreMarkers() {
            nearbyStores.forEach(store => {
                L.marker([store.lat, store.lng]).addTo(map).bindPopup(store.name);
            });
        }

        function showSuggestions() {
            const suggDiv = document.getElementById('suggestions');
            const list = document.getElementById('suggestion-list');
            list.innerHTML = '';
            suggestions.slice(0, 8).forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                li.onclick = () => document.getElementById('search-input').value = s;
                list.appendChild(li);
            });
            suggDiv.style.display = 'block';
        }

        // Display stores with browse button
        function displayStores() {
            const storesList = document.getElementById('stores-list');
            storesList.innerHTML = '';

            nearbyStores.forEach(store => {
                const storeCard = document.createElement('div');
                storeCard.className = 'store-card';
                storeCard.onclick = (e) => { if (e.target.tagName !== 'BUTTON') toggleBrowse(store.name); };

                const storeName = document.createElement('h3');
                storeName.textContent = store.name;
                storeCard.appendChild(storeName);

                const address = document.createElement('p');
                address.textContent = `Address: ${store.vicinity || 'Nearby'}`;
                storeCard.appendChild(address);

                const browseBtn = document.createElement('button');
                browseBtn.className = 'browse-btn';
                browseBtn.textContent = 'Browse All Products';
                browseBtn.onclick = (e) => { e.stopPropagation(); toggleBrowse(store.name); };
                storeCard.appendChild(browseBtn);

                const productList = document.createElement('ul');
                productList.className = 'product-list';

                Object.keys(mockProducts).slice(0, 5).forEach(productName => { // Show top 5 as teaser
                    const productItem = document.createElement('li');
                    productItem.className = 'product-item';
                    const variedPrice = (mockProducts[productName].stores[store.name] || mockProducts[productName].avg + (Math.random() - 0.5) * 2).toFixed(2);
                    productItem.innerHTML = `<strong>${productName}:</strong> ₱${variedPrice}`;
                    productList.appendChild(productItem);
                });
                storeCard.appendChild(productList);

                // Browse details
                const browseDetails = document.createElement('div');
                browseDetails.className = 'browse-details';
                if (storeProducts[store.name]) {
                    Object.keys(storeProducts[store.name]).forEach(cat => {
                        const catDiv = document.createElement('div');
                        const catTitle = document.createElement('div');
                        catTitle.className = 'category';
                        catTitle.textContent = cat;
                        catDiv.appendChild(catTitle);
                        const catList = document.createElement('ul');
                        storeProducts[store.name][cat].forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            catList.appendChild(li);
                        });
                        catDiv.appendChild(catList);
                        browseDetails.appendChild(catDiv);
                    });
                } else {
                    browseDetails.innerHTML = '<p>Common groceries available (e.g., rice, milk, snacks).</p>';
                }
                storeCard.appendChild(browseDetails);

                storesList.appendChild(storeCard);
            });
        }

        function toggleBrowse(storeName) {
            const details = document.querySelectorAll('.browse-details');
            details.forEach(d => d.style.display = d.style.display === 'block' ? 'none' : 'block');
            // Or target specific, but for simplicity, toggle all
        }

        // Search & compare
        async function searchProduct() {
            const query = document.getElementById('search-input').value.trim();
            if (!query || nearbyStores.length === 0) return;

            const loading = document.getElementById('loading');
            const comparisonSection = document.getElementById('comparison-section');
            const searchTerm = document.getElementById('search-term');
            const tableBody = document.getElementById('comparison-table-body');
            tableBody.innerHTML = '';
            loading.style.display = 'inline-block';
            comparisonSection.style.display = 'block';

            searchTerm.textContent = query;
            let prices = [];

            for (const store of nearbyStores) {
                const realData = await fetchRealPrices(query, store.name);
                let price, brand, source;
                if (realData) {
                    price = realData.price;
                    brand = realData.brand;
                    source = realData.source;
                } else {
                    const mockData = mockProducts[query] || { avg: 50.00 };
                    price = mockData.stores[store.name] || mockData.avg;
                    brand = query.split(' ')[0];
                    source = '2025 PH avg';
                }
                prices.push({ store: store.name, price, brand, source });

                const row = document.createElement('tr');
                const storeCell = document.createElement('td');
                storeCell.textContent = store.name;
                const brandCell = document.createElement('td');
                brandCell.textContent = brand;
                const priceCell = document.createElement('td');
                priceCell.innerHTML = `₱${price.toFixed(2)}`;
                if (realData) priceCell.classList.add('real-price');
                const sourceCell = document.createElement('td');
                sourceCell.textContent = source;
                row.appendChild(storeCell);
                row.appendChild(brandCell);
                row.appendChild(priceCell);
                row.appendChild(sourceCell);
                tableBody.appendChild(row);
            }

            loading.style.display = 'none';

            // Highlight lowest
            const lowestPrice = Math.min(...prices.map(p => p.price));
            tableBody.querySelectorAll('tr').forEach(row => {
                const priceCell = row.cells[2];
                if (parseFloat(priceCell.textContent.replace('₱', '')) === lowestPrice) {
                    priceCell.classList.add('lowest-price');
                }
            });
        }

        // Events
        document.getElementById('locate-btn').addEventListener('click', getLocation);
        document.getElementById('search-btn').addEventListener('click', searchProduct);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchProduct();
        });

        window.addEventListener('load', () => {
            initMap();
            showSuggestions();
        });
    </script>
</body>
</html>
